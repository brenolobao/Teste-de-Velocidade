<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medidor de Velocidade de Internet</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100..900;1,100..900&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            height: 100vh;
            display: grid;
            place-items: center;
            background-color: #EEEEEE;
            font-family: 'Roboto', sans-serif;
            color: #434242;
            overflow-y: auto;
        }

        .container {
            width: 100%;
            height: 100%;
            background-color: white;
            border-radius: 20px;
            padding: 15px;
            display: flex;
            align-items: center;
            flex-direction: column;
            justify-content: flex-start;
            font-size: 1.2em;
            overflow-y: auto;
        }

        .header-area {
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 0;
            flex-wrap: wrap;
        }

        h1 {
            color: #333;
            margin: 0;
            padding: 0 10px;
            text-align: left;
            flex-grow: 1;
            font-size: 1.8em;
        }

        h2 {
            margin-bottom: 20px;
            color: #434242;
            font-size: 1.3em;
        }

        h3 {
            color: #333;
            margin-bottom: 15px;
        }

        .mode-selection {
            margin: 0;
            display: flex;
            justify-content: flex-end;
            flex-wrap: wrap;
            gap: 8px;
            padding: 0 10px;
            flex-shrink: 0;
        }

        .mode-selection button {
            background-color: #6c757d;
            color: white;
            padding: 6px 12px;
            font-size: 0.85em;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            flex-shrink: 0;
        }

        .mode-selection button.active {
            background-color: #007bff;
        }

        .mode-selection button:hover {
            background-color: #5a6268;
        }

        .box {
            width: 90%;
            height: calc(100% - 80px);
            margin-bottom: 0;
            margin-top: 15px;
            border: 1px solid #E4E4E4;
            border-radius: 15px;
            display: flex;
            overflow: hidden;
            flex-grow: 1;
        }

        .innerBox1 {
            height: 100%;
            width: 30%;
            border-right: 1px solid #E4E4E4;
            padding: 20px;
            display: flex;
            flex-direction: column;
            color: #434242;
            overflow-y: auto;
            align-items: center;
        }

        .innerBox2 {
            height: 100%;
            width: 70%;
            padding: 20px;
            display: flex;
            flex-direction: column;
            color: #434242;
            overflow-y: auto;
            text-align: center;
        }

        .controls {
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 20px;
            width: 100%;
            max-width: 300px;
            margin: 0 auto;
        }

        .controls div {
            width: 100%;
            text-align: left;
        }

        .controls label {
            font-size: 1.1em;
            color: #555;
            display: block;
            margin-bottom: 8px;
        }

        .controls select,
        .controls input[type="text"] {
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #ddd;
            font-size: 1em;
            width: 100%;
            box-sizing: border-box;
        }

        button {
            background-color: #007bff;
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 17px;
            margin-top: 25px;
            transition: background-color 0.3s ease;
            width: 100%;
            max-width: 280px;
            margin-left: auto;
            margin-right: auto;
            display: block;
        }

        button:hover {
            background-color: #0056b3;
        }

        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        #progress {
            margin-top: 20px;
            margin-bottom: 20px;
            font-size: 1.2em;
            color: #444;
            min-height: 1.5em;
        }

        #chartContainer,
        #generalCyclesChartContainer {
            margin-top: 40px;
            position: relative;
            height: 350px;
            width: 100%;
        }

        #chartContainer h2,
        #generalCyclesChartContainer h2 {
            margin-bottom: 15px;
            color: #333;
            font-size: 1.3em;
        }

        #resultsSummary {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid #eee;
            font-size: 1.2em;
            color: #333;
            text-align: left;
            width: 100%;
        }

        #resultsSummary h2,
        #resultsSummary h3 {
            margin-bottom: 15px;
            color: #333;
            text-align: center;
        }

        #resultsSummary p {
            margin: 10px 0;
        }

        #resultsSummary strong {
            color: #007bff;
        }

        #downloadReportButton {
            background-color: #28a745;
            margin-top: 30px;
            display: none;
        }

        #downloadReportButton:hover {
            background-color: #218838;
        }

        #mappingControls {
            margin-top: 20px;
            padding: 15px;
            border: 1px dashed #ccc;
            border-radius: 8px;
            background-color: #f9f9f9;
            display: none;
            width: 100%;
            max-width: 300px;
            text-align: center;
        }

        #roomInputGroup {
            margin-top: 15px;
            margin-bottom: 15px;
            width: 100%;
            text-align: left;
        }

        #mappingProgress {
            font-size: 1.1em;
            color: #666;
            margin-bottom: 10px;
        }

        @media (max-width: 768px) {
            body {
                height: auto;
                overflow-y: auto;
            }

            .container {
                width: 100%;
                height: 100%;
                border-radius: 0;
                padding: 10px;
                overflow-y: auto;
                justify-content: flex-start;
            }

            .header-area {
                flex-direction: column;
                align-items: center;
                padding: 5px 0;
            }

            h1 {
                font-size: 1.3em;
                margin-bottom: 12px;
                padding: 0;
                text-align: center;
            }

            .mode-selection {
                flex-direction: row;
                justify-content: center;
                align-items: center;
                gap: 5px;
                padding: 0;
                width: 100%;
                margin-top: 10px;
            }

            .mode-selection button {
                width: auto;
                max-width: 48%;
                font-size: 0.75em;
                padding: 4px 8px;
            }

            .box {
                flex-direction: column;
                height: auto;
                width: 95%;
                margin-bottom: 15px;
                margin-top: 15px;
                overflow: visible;
            }

            .innerBox1,
            .innerBox2 {
                width: 100%;
                border-right: none;
                padding: 15px;
                overflow-y: visible;
                align-items: center;
            }

            .innerBox1 {
                border-bottom: 1px solid #E4E4E4;
            }

            h2 {
                margin-bottom: 10px;
                font-size: 1.2em;
            }

            .controls {
                max-width: none;
                align-items: center;
            }

            .controls div {
                width: 90%;
                text-align: center;
            }

            .controls label {
                text-align: center;
            }

            .controls select,
            .controls input[type="text"] {
                max-width: 90%;
                margin: 0 auto;
            }

            button {
                max-width: 90%;
            }

            #chartContainer {
                height: 280px;
                margin-top: 30px;
                margin-bottom: 30px;
            }

            #generalCyclesChartContainer {
                height: 280px;
                margin-top: 50px;
            }

            #resultsSummary {
                text-align: center;
            }

            #resultsSummary h2,
            #resultsSummary h3 {
                text-align: center;
            }

            #mappingControls {
                max-width: 90%;
            }

            #roomInputGroup {
                text-align: center;
            }

            #roomInputGroup input {
                max-width: 90%;
            }
        }

        @media (min-width: 769px) and (max-width: 991px) {

            h1 {
                font-size: 1.6em;
            }

            .mode-selection button {
                padding: 8px 15px;
                font-size: 0.9em;
            }
        }

        @media (min-width: 992px) {
            body {
                padding: 0;
            }

            .container {
                width: 100%;
                max-width: 1400px;
                height: 100%;
                padding: 0;
                flex-direction: column;
                overflow: hidden;
            }

            .header-area {
                padding: 20px 30px 10px 30px;
                flex-wrap: nowrap;
                justify-content: flex-start;
                align-items: baseline;
            }

            h1 {
                font-size: 1.8em;
                flex-grow: 1;
                white-space: nowrap;
                margin-right: 20px;
            }

            .mode-selection {
                flex-wrap: nowrap;
                padding-left: 0;
                gap: 10px;
                margin-top: 0;
                flex-shrink: 0;
            }

            .mode-selection button {
                max-width: 175px;
                font-size: 1em;
                padding: 10px 20px;
            }

            .box {
                flex-direction: row;
                height: calc(100% - 100px);
                margin-top: 10px;
                width: 95%;
                max-width: 1200px;
            }

            .innerBox1 {
                width: 30%;
                border-right: 1px solid #E4E4E4;
                border-bottom: none;
                padding: 30px 20px;
                align-items: center;
                justify-content: flex-start;
            }

            .innerBox2 {
                width: 70%;
                padding: 30px;
                text-align: center;
                justify-content: flex-start;
            }

            .controls {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
                width: 100%;
                max-width: none;
            }

            .controls div {
                width: 100%;
                text-align: left;
            }

            .controls label {
                text-align: left;
            }

            .controls select,
            .controls input[type="text"] {
                max-width: none;
                margin: 0;
            }

            button {
                max-width: 90%;
                margin-top: 30px;
            }

            #chartContainer,
            #generalCyclesChartContainer {
                height: auto;
                max-height: 40vh;
                margin-top: 30px;
                margin-bottom: 30px;
            }

            #chartContainer h2,
            #generalCyclesChartContainer h2 {
                margin-bottom: 25px;
                margin-top: 0;
            }

            #resultsSummary {
                margin-top: 30px;
                padding-top: 20px;
                text-align: center;
            }

            #resultsSummary h2,
            #resultsSummary h3 {
                text-align: center;
            }

            #downloadReportButton {
                margin-top: 30px;
            }

            #mappingControls {
                max-width: none;
                text-align: center;
            }

            #roomInputGroup {
                text-align: left;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header-area">
            <h1>Medidor de Velocidade da Internet</h1>
            <div class="mode-selection">
                <button id="normalModeBtn" class="active">Teste Normal</button>
                <button id="mappingModeBtn">Mapear Casa</button>
            </div>
        </div>

        <div class="box">
            <div class="innerBox1">
                <div id="normalTestSection">
                    <h2>Controles</h2>
                    <div class="controls">
                        <div>
                            <label for="numGeneralCycles">Número de Rodadas Gerais:</label>
                            <select id="numGeneralCycles">
                                <option value="1" selected>1 rodada</option>
                                <option value="2">2 rodadas</option>
                                <option value="3">3 rodadas</option>
                                <option value="5">5 rodadas</option>
                                <option value="10">10 rodadas</option>
                            </select>
                        </div>
                        <div>
                            <label for="numUniqueCycles">Downloads por Rodada:</label>
                            <select id="numUniqueCycles">
                                <option value="5">5 downloads</option>
                                <option value="10" selected>10 downloads</option>
                                <option value="20">20 downloads</option>
                                <option value="50">50 downloads</option>
                            </select>
                        </div>
                    </div>
                    <button id="startButton">Iniciar Teste</button>
                </div>

                <div id="mappingControls" style="display: none;">
                    <h2>Controles de Mapeamento</h2>
                    <p id="mappingProgress">Para iniciar o mapeamento, digite o nome do cômodo (ex: "Roteador") e clique
                        em 'Realizar Teste neste Cômodo'.</p>
                    <div id="roomInputGroup">
                        <label for="currentRoom">Nome do Cômodo:</label>
                        <input type="text" id="currentRoom" placeholder="Ex: Sala, Quarto, Cozinha">
                    </div>
                    <button id="startMappingTestBtn">Realizar Teste neste Cômodo</button>
                    <button id="finishMappingBtn" style="background-color: #dc3545; display: none;">Finalizar
                        Mapeamento</button>
                </div>
            </div>

            <div class="innerBox2">
                <h2>Gráficos</h2>
                <div id="progress">Progresso: --</div>

                <div id="chartContainer">
                    <h2>Velocidade de Cada Download</h2>
                    <canvas id="speedChart"></canvas>
                </div>

                <div id="generalCyclesChartContainer">
                    <h2>Média de Velocidade por Rodada Geral</h2>
                    <canvas id="generalCyclesChart"></canvas>
                </div>

                <div id="resultsSummary"></div>
                <button id="downloadReportButton" style="display: none;">Baixar Relatório</button>
            </div>
        </div>
    </div>

    <script>
        const startButton = document.getElementById('startButton');
        const numGeneralCyclesSelect = document.getElementById('numGeneralCycles');
        const numUniqueCyclesSelect = document.getElementById('numUniqueCycles');
        const progressDiv = document.getElementById('progress');
        const resultsSummaryDiv = document.getElementById('resultsSummary');
        const individualChartCanvas = document.getElementById('speedChart');
        const generalChartCanvas = document.getElementById('generalCyclesChart');
        const downloadReportButton = document.getElementById('downloadReportButton');

        const normalModeBtn = document.getElementById('normalModeBtn');
        const mappingModeBtn = document.getElementById('mappingModeBtn');
        const normalTestSection = document.getElementById('normalTestSection');
        const mappingControls = document.getElementById('mappingControls');
        const mappingProgress = document.getElementById('mappingProgress');
        const currentRoomInput = document.getElementById('currentRoom');
        const startMappingTestBtn = document.getElementById('startMappingTestBtn');
        const finishMappingBtn = document.getElementById('finishMappingBtn');

        const fileUrl = 'https://brenolobao.github.io/Teste-de-Velocidade/15MBtest.zip';
        const fileSizeInBytes = 15728640;

        let numGeneralCycles = 0;
        let numUniqueCycles = 0;
        let individualDownloadSpeeds = [];
        let generalCycleAverageSpeeds = [];
        let individualSpeedChart;
        let generalCycleSpeedChart;
        let testStartTime;
        let finalReportData = {};

        let currentMode = 'normal';
        let mappingResults = [];

        function initializeCharts() {
            if (individualSpeedChart) {
                individualSpeedChart.destroy();
            }
            individualSpeedChart = new Chart(individualChartCanvas, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Velocidade de Download (Mbps)',
                        data: [],
                        borderColor: '#007bff',
                        backgroundColor: 'rgba(0, 123, 255, 0.1)',
                        fill: true,
                        tension: 0.4,
                        pointRadius: 3,
                        pointBackgroundColor: '#007bff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Download #'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Velocidade (Mbps)'
                            },
                            beginAtZero: true,
                            min: 0
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    return `${context.dataset.label}: ${context.raw.toFixed(2)} Mbps`;
                                }
                            }
                        }
                    }
                }
            });

            if (generalCycleSpeedChart) {
                generalCycleSpeedChart.destroy();
            }
            generalCycleSpeedChart = new Chart(generalChartCanvas, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Média de Velocidade por Rodada (Mbps)',
                        data: [],
                        borderColor: '#28a745',
                        backgroundColor: 'rgba(40, 167, 69, 0.1)',
                        fill: true,
                        tension: 0.4,
                        pointRadius: 3,
                        pointBackgroundColor: '#28a745'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Rodada Geral #'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Média de Velocidade (Mbps)'
                            },
                            beginAtZero: true,
                            min: 0
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    return `${context.dataset.label}: ${context.raw.toFixed(2)} Mbps`;
                                }
                            }
                        }
                    }
                }
            });
        }

        async function measureSpeed() {
            try {
                const startTime = performance.now();
                const response = await fetch(fileUrl + '?cacheBuster=' + new Date().getTime());

                if (!response.ok) {
                    throw new Error(`Erro HTTP: ${response.status} ${response.statusText}`);
                }

                const blob = await response.blob();
                const endTime = performance.now();

                const downloadTimeMs = endTime - startTime;

                const speedBps = (downloadTimeMs > 0) ? (fileSizeInBytes / (downloadTimeMs / 1000)) : (fileSizeInBytes * 1000);

                return speedBps;
            } catch (error) {
                console.error("Erro ao medir a velocidade:", error);
                return 0;
            }
        }

        async function startNormalTest() {
            startButton.disabled = true;
            numGeneralCyclesSelect.disabled = true;
            numUniqueCyclesSelect.disabled = true;
            downloadReportButton.style.display = 'none';
            resultsSummaryDiv.innerHTML = '';

            numGeneralCycles = parseInt(numGeneralCyclesSelect.value);
            numUniqueCycles = parseInt(numUniqueCyclesSelect.value);
            individualDownloadSpeeds = [];
            generalCycleAverageSpeeds = [];
            testStartTime = performance.now();
            finalReportData = {};

            progressDiv.textContent = `Preparando teste...`;

            initializeCharts();
            let totalDownloadsCompleted = 0;

            for (let g = 0; g < numGeneralCycles; g++) {
                let currentGeneralCycleSpeeds = [];
                for (let u = 0; u < numUniqueCycles; u++) {
                    totalDownloadsCompleted++;
                    progressDiv.textContent = `Rodada ${g + 1}/${numGeneralCycles} - Download ${u + 1}/${numUniqueCycles} (${totalDownloadsCompleted} total)`;

                    const currentSpeedBps = await measureSpeed();
                    individualDownloadSpeeds.push(currentSpeedBps);
                    currentGeneralCycleSpeeds.push(currentSpeedBps);

                    const speedMbps = (currentSpeedBps * 8) / (1024 * 1024);

                    individualSpeedChart.data.labels.push(`#${totalDownloadsCompleted}`);
                    individualSpeedChart.data.datasets[0].data.push(speedMbps);
                    individualSpeedChart.update();
                }

                if (currentGeneralCycleSpeeds.length > 0) {
                    const validGeneralCycleSpeeds = currentGeneralCycleSpeeds.filter(speed => speed > 0);
                    if (validGeneralCycleSpeeds.length > 0) {
                        const averageGeneralSpeedBps = validGeneralCycleSpeeds.reduce((sum, speed) => sum + speed, 0) / validGeneralCycleSpeeds.length;
                        const averageGeneralSpeedMbps = (averageGeneralSpeedBps * 8) / (1024 * 1024);
                        generalCycleAverageSpeeds.push(averageGeneralSpeedMbps);

                        generalCycleSpeedChart.data.labels.push(`Rodada ${g + 1}`);
                        generalCycleSpeedChart.data.datasets[0].data.push(averageGeneralSpeedMbps);
                        generalCycleSpeedChart.update();
                    } else {
                        generalCycleAverageSpeeds.push(0);
                        generalCycleSpeedChart.data.labels.push(`Rodada ${g + 1}`);
                        generalCycleSpeedChart.data.datasets[0].data.push(0);
                        generalCycleSpeedChart.update();
                    }
                }
            }

            finalizeNormalTest();
        }

        function finalizeNormalTest() {
            const totalTestTimeMs = performance.now() - testStartTime;
            const totalTestTimeSeconds = (totalTestTimeMs / 1000).toFixed(2);

            startButton.disabled = false;
            numGeneralCyclesSelect.disabled = false;
            numUniqueCyclesSelect.disabled = false;
            progressDiv.textContent = `Teste concluído em ${totalTestTimeSeconds} segundos.`;

            let finalOverallAverage = 0;

            if (individualDownloadSpeeds.length > 0) {
                const validIndividualSpeeds = individualDownloadSpeeds.filter(speed => speed > 0);

                if (validIndividualSpeeds.length > 0) {
                    const speedsMbps = validIndividualSpeeds.map(speedBps => (speedBps * 8) / (1024 * 1024));

                    const bestSpeed = Math.max(...speedsMbps);
                    const worstSpeed = Math.min(...speedsMbps);
                    const averageSpeed = speedsMbps.reduce((sum, speed) => sum + speed, 0) / speedsMbps.length;

                    resultsSummaryDiv.innerHTML = `
                        <h2>Resultados Finais (Todos os Downloads)</h2>
                        <p>Total de Downloads Realizados: <strong>${individualDownloadSpeeds.length}</strong></p>
                        <p>Melhor Velocidade Individual: <strong>${bestSpeed.toFixed(2)} Mbps</strong></p>
                        <p>Pior Velocidade Individual: <strong>${worstSpeed.toFixed(2)} Mbps</strong></p>
                        <p>Velocidade Média Geral: <strong>${averageSpeed.toFixed(2)} Mbps</strong></p>
                    `;

                    finalReportData.totalDownloads = individualDownloadSpeeds.length;
                    finalReportData.bestIndividualSpeed = bestSpeed.toFixed(2);
                    finalReportData.worstIndividualSpeed = worstSpeed.toFixed(2);
                    finalReportData.averageOverallSpeed = averageSpeed.toFixed(2);

                } else {
                    resultsSummaryDiv.innerHTML = '<p>Não foi possível obter medições válidas de download.</p>';
                }
            } else {
                resultsSummaryDiv.innerHTML = '<p>Nenhuma medição de velocidade de download realizada.</p>';
            }

            if (generalCycleAverageSpeeds.length > 0) {
                const validGeneralAverages = generalCycleAverageSpeeds.filter(speed => speed > 0);
                if (validGeneralAverages.length > 0) {
                    finalOverallAverage = validGeneralAverages.reduce((sum, speed) => sum + speed, 0) / validGeneralAverages.length;
                    resultsSummaryDiv.innerHTML += `
                        <h3>Média das Rodadas Gerais: <strong>${finalOverallAverage.toFixed(2)} Mbps</strong></h3>
                    `;
                    finalReportData.averageGeneralCycles = finalOverallAverage.toFixed(2);
                    finalReportData.generalCycleAverages = generalCycleAverageSpeeds.map((speed, index) => `Rodada ${index + 1}: ${speed.toFixed(2)} Mbps`);
                }
            }
            finalReportData.testDuration = totalTestTimeSeconds;
            finalReportData.numGeneralCycles = numGeneralCycles;
            finalReportData.numUniqueCycles = numUniqueCycles;
            finalReportData.isMappingTest = false;

            downloadReportButton.style.display = 'block';
        }

        async function startMappingFlow() {
            mappingResults = [];
            finishMappingBtn.style.display = 'none';
            resultsSummaryDiv.innerHTML = '';

            numGeneralCyclesSelect.disabled = false;
            numUniqueCyclesSelect.disabled = false;

            numGeneralCyclesSelect.value = "1";
            numUniqueCyclesSelect.value = "5";

            numGeneralCyclesSelect.disabled = true;
            numUniqueCyclesSelect.disabled = true;

            mappingProgress.textContent = "Para iniciar o mapeamento, digite o nome do cômodo (ex: 'Roteador') e clique em 'Realizar Teste neste Cômodo'.";
            currentRoomInput.value = '';
            currentRoomInput.focus();
            startMappingTestBtn.disabled = false;
            generalCycleAverageSpeeds = [];
            testStartTime = performance.now();
        }

        async function performRoomTest() {
            const roomName = currentRoomInput.value.trim();
            if (!roomName) {
                alert("Por favor, digite o nome do cômodo.");
                currentRoomInput.focus();
                return;
            }

            startMappingTestBtn.disabled = true;
            finishMappingBtn.disabled = true;
            progressDiv.textContent = `Realizando teste de velocidade em "${roomName}"...`;

            numGeneralCycles = 1;
            numUniqueCycles = parseInt(numUniqueCyclesSelect.value);

            individualDownloadSpeeds = [];

            individualSpeedChart.data.labels = [];
            individualSpeedChart.data.datasets[0].data = [];
            individualSpeedChart.update();


            let currentRoomTotalSpeedBps = 0;
            let currentRoomValidDownloads = 0;
            let currentRoomIndividualSpeedsMbps = [];

            for (let u = 0; u < numUniqueCycles; u++) {
                progressDiv.textContent = `Teste em "${roomName}": Download ${u + 1}/${numUniqueCycles}`;
                const currentSpeedBps = await measureSpeed();

                if (currentSpeedBps > 0) {
                    currentRoomTotalSpeedBps += currentSpeedBps;
                    currentRoomValidDownloads++;
                }

                const speedMbps = (currentSpeedBps * 8) / (1024 * 1024);
                currentRoomIndividualSpeedsMbps.push(speedMbps);

                individualSpeedChart.data.labels.push(`D ${u + 1} (${roomName})`);
                individualSpeedChart.data.datasets[0].data.push(speedMbps);
                individualSpeedChart.update();
            }

            let roomAverageSpeedMbps = 0;
            if (currentRoomValidDownloads > 0) {
                const roomAverageSpeedBps = currentRoomTotalSpeedBps / currentRoomValidDownloads;
                roomAverageSpeedMbps = (roomAverageSpeedBps * 8) / (1024 * 1024);
            }

            generalCycleSpeedChart.data.labels.push(roomName);
            generalCycleSpeedChart.data.datasets[0].data.push(roomAverageSpeedMbps);
            generalCycleSpeedChart.update();

            mappingResults.push({
                room: roomName,
                speed: roomAverageSpeedMbps.toFixed(2),
                individualSpeeds: currentRoomIndividualSpeedsMbps
            });

            mappingProgress.textContent = `Teste em "${roomName}" (${roomAverageSpeedMbps.toFixed(2)} Mbps) concluído! Agora, vá para outro cômodo, digite o nome e clique em 'Realizar Teste neste Cômodo', ou clique em 'Finalizar Mapeamento'.`;
            currentRoomInput.value = '';
            currentRoomInput.focus();

            startMappingTestBtn.disabled = false;
            finishMappingBtn.style.display = 'block';
            finishMappingBtn.disabled = false;
            progressDiv.textContent = `Teste de cômodo concluído.`;
        }

        function finalizeMappingTest() {
            finalReportData.isMappingTest = true;
            finalReportData.mappingResults = mappingResults;
            finalReportData.testDuration = ((performance.now() - testStartTime) / 1000).toFixed(2);

            resultsSummaryDiv.innerHTML = `
                <h2>Mapeamento de Sinal Concluído!</h2>
                <p>O relatório detalhado estará no PDF.</p>
                <p>Total de cômodos testados: <strong>${mappingResults.length}</strong></p>
                <p>Duração total do mapeamento: <strong>${finalReportData.testDuration} segundos</strong></p>
            `;

            downloadReportButton.style.display = 'block';
            downloadReportButton.disabled = false;

            mappingProgress.textContent = "Mapeamento finalizado. Você pode baixar o relatório ou iniciar um novo mapeamento.";
            startMappingTestBtn.disabled = false;
            finishMappingBtn.style.display = 'none';
            currentRoomInput.value = '';
        }

        function downloadImage(canvas, filename) {
            if (!canvas || !canvas.getContext) {
                console.error("Canvas inválido para download da imagem.");
                return;
            }

            const imgData = canvas.toDataURL('image/png');
            const link = document.createElement('a');
            link.href = imgData;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        async function generatePdfReport() {
            downloadReportButton.disabled = true;
            downloadReportButton.textContent = 'Gerando...';

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({
                orientation: 'portrait',
                unit: 'mm',
                format: 'a4'
            });

            let yPos = 20;
            const pageWidth = doc.internal.pageSize.getWidth();
            const margin = 10;

            doc.setFontSize(18);
            doc.text("Relatório de Teste de Velocidade da Internet", pageWidth / 2, yPos, { align: 'center' });
            yPos += 15;

            doc.setFontSize(12);
            doc.text(`Data do Teste: ${new Date().toLocaleString('pt-BR')}`, margin, yPos);
            yPos += 10;
            doc.text(`Duração Total do Teste: ${finalReportData.testDuration || 'N/A'} segundos`, margin, yPos);
            yPos += 15;

            if (finalReportData.isMappingTest) {
                doc.setFontSize(16);
                doc.text("Relatório de Mapeamento de Sinal Wi-Fi", margin, yPos);
                yPos += 10;

                doc.setFontSize(12);
                doc.text(`Total de Cômodos Testados: ${finalReportData.mappingResults ? finalReportData.mappingResults.length : 'N/A'}`, margin, yPos);
                yPos += 15;

                doc.setFontSize(14);
                doc.text("Detalhes de Velocidade por Cômodo:", margin, yPos);
                yPos += 10;

                for (const result of finalReportData.mappingResults) {
                    if (yPos + 20 > doc.internal.pageSize.height) {
                        doc.addPage();
                        yPos = 20;
                    }
                    doc.setFontSize(12);
                    doc.text(`Cômodo: ${result.room} - Velocidade Média: ${result.speed} Mbps`, margin, yPos);
                    yPos += 8;
                }

                yPos += 15;
            } else {
                doc.setFontSize(12);
                doc.text(`Configuração do Teste: ${finalReportData.numGeneralCycles || 'N/A'} Rodadas Gerais, ${finalReportData.numUniqueCycles || 'N/A'} Downloads por Rodada`, margin, yPos);
                yPos += 15;

                doc.setFontSize(16);
                doc.text("Resultados Finais (Todos os Downloads)", margin, yPos);
                yPos += 10;
                doc.setFontSize(12);
                doc.text(`Total de Downloads Realizados: ${finalReportData.totalDownloads || 'N/A'}`, margin, yPos);
                yPos += 10;
                doc.text(`Melhor Velocidade Individual: ${finalReportData.bestIndividualSpeed || 'N/A'} Mbps`, margin, yPos);
                yPos += 10;
                doc.text(`Pior Velocidade Individual: ${finalReportData.worstIndividualSpeed || 'N/A'} Mbps`, margin, yPos);
                yPos += 10;
                doc.text(`Velocidade Média Geral: ${finalReportData.averageOverallSpeed || 'N/A'} Mbps`, margin, yPos);
                yPos += 15;

                if (finalReportData.averageGeneralCycles) {
                    doc.setFontSize(14);
                    doc.text(`Média de Todas as Rodadas: ${finalReportData.averageGeneralCycles} Mbps`, margin, yPos);
                    yPos += 15;
                }
            }

            doc.save("Relatorio_Teste_Velocidade.pdf");

            setTimeout(() => {
                if (!finalReportData.isMappingTest) {
                    if (individualSpeedChart) {
                        downloadImage(individualChartCanvas, 'grafico_velocidade_individual.png');
                    }
                }

                setTimeout(() => {
                    if (generalCycleSpeedChart) {
                        downloadImage(generalChartCanvas, 'grafico_medias_gerais.png');
                    }
                }, 500);
            }, 500);

            downloadReportButton.disabled = false;
            downloadReportButton.textContent = 'Baixar Relatório';
        }

        function setMode(mode) {
            currentMode = mode;
            if (mode === 'normal') {
                normalModeBtn.classList.add('active');
                mappingModeBtn.classList.remove('active');
                normalTestSection.style.display = 'block';
                mappingControls.style.display = 'none';
                startButton.style.display = 'block';
                downloadReportButton.style.display = 'none';
                resultsSummaryDiv.innerHTML = '';

                numGeneralCyclesSelect.disabled = false;
                numUniqueCyclesSelect.disabled = false;

                document.getElementById('chartContainer').style.display = 'block';
                document.getElementById('generalCyclesChartContainer').style.display = 'block';


            } else {
                normalModeBtn.classList.remove('active');
                mappingModeBtn.classList.add('active');
                normalTestSection.style.display = 'none';
                mappingControls.style.display = 'block';
                startButton.style.display = 'none';
                downloadReportButton.style.display = 'none';
                resultsSummaryDiv.innerHTML = '';

                document.getElementById('chartContainer').style.display = 'block';
                document.getElementById('generalCyclesChartContainer').style.display = 'block';

                startMappingFlow();
            }
            initializeCharts();
        }

        normalModeBtn.addEventListener('click', () => setMode('normal'));
        mappingModeBtn.addEventListener('click', () => setMode('mapping'));
        startButton.addEventListener('click', startNormalTest);
        startMappingTestBtn.addEventListener('click', performRoomTest);
        finishMappingBtn.addEventListener('click', finalizeMappingTest);
        downloadReportButton.addEventListener('click', generatePdfReport);

        setMode('normal');
        initializeCharts();
    </script>
</body>

</html>
